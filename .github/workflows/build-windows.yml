name: Build Windows Executable

on:
  push:
    branches: [ main, master, claude/** ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Download DjVuLibre tools
      shell: powershell
      run: |
        # Create bin directory
        New-Item -ItemType Directory -Force -Path bin

        # Download DjVuLibre for Windows (use direct mirror link)
        Write-Host "Downloading DjVuLibre..."
        $url = "https://downloads.sourceforge.net/project/djvu/DjVuLibre_Win32/3.5.28/djvulibre-3.5.28-win.zip"
        Invoke-WebRequest -Uri $url -OutFile "djvulibre.zip" -UserAgent "Mozilla/5.0"

        Write-Host "Extracting DjVuLibre..."
        Expand-Archive -Path "djvulibre.zip" -DestinationPath "djvulibre" -Force

        # Copy required executables
        Copy-Item "djvulibre\djvulibre-3.5.28\bin\djvused.exe" -Destination "bin\"
        Copy-Item "djvulibre\djvulibre-3.5.28\bin\ddjvu.exe" -Destination "bin\"

        # Copy required DLLs
        Copy-Item "djvulibre\djvulibre-3.5.28\bin\*.dll" -Destination "bin\"

        Write-Host "DjVuLibre tools installed"

    - name: Download djvu2hocr script directly
      shell: powershell
      run: |
        # Download djvu2hocr script directly from GitHub
        Write-Host "Downloading djvu2hocr..."
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/hocr/djvu2hocr" -OutFile "bin\djvu2hocr"

        # Download required Python modules
        New-Item -ItemType Directory -Force -Path "bin\djvu"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/cli.py" -OutFile "bin\cli.py"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/hocr.py" -OutFile "bin\hocr.py"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/text_zones.py" -OutFile "bin\text_zones.py"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/ipc.py" -OutFile "bin\ipc.py"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/temporary.py" -OutFile "bin\temporary.py"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/unicode_support.py" -OutFile "bin\unicode_support.py"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/utils.py" -OutFile "bin\utils.py"

        # Install lxml which is required
        pip install lxml

        Write-Host "djvu2hocr downloaded"

    - name: Download LibTIFF tools
      shell: powershell
      run: |
        # Download GnuWin32 LibTIFF (use direct mirror links)
        Write-Host "Downloading LibTIFF..."
        $binUrl = "https://downloads.sourceforge.net/project/gnuwin32/tiff/3.8.2-1/tiff-3.8.2-1-bin.zip"
        $depUrl = "https://downloads.sourceforge.net/project/gnuwin32/tiff/3.8.2-1/tiff-3.8.2-1-dep.zip"

        Invoke-WebRequest -Uri $binUrl -OutFile "libtiff-bin.zip" -UserAgent "Mozilla/5.0"
        Invoke-WebRequest -Uri $depUrl -OutFile "libtiff-dep.zip" -UserAgent "Mozilla/5.0"

        Write-Host "Extracting LibTIFF..."
        Expand-Archive -Path "libtiff-bin.zip" -DestinationPath "libtiff" -Force
        Expand-Archive -Path "libtiff-dep.zip" -DestinationPath "libtiff" -Force

        # Copy tiffsplit
        Copy-Item "libtiff\bin\tiffsplit.exe" -Destination "bin\"
        Copy-Item "libtiff\bin\*.dll" -Destination "bin\" -Force

        Write-Host "LibTIFF tools installed"

    - name: Install pdfbeads
      run: gem install pdfbeads

    - name: Set up djvu2hocr wrapper
      shell: powershell
      run: |
        # Create wrapper batch file for djvu2hocr script
        $scriptPath = (Resolve-Path "bin\djvu2hocr").Path
        Write-Host "djvu2hocr script at: $scriptPath"

        # Create wrapper batch file
        "@echo off" | Out-File -FilePath "bin\djvu2hocr.bat" -Encoding ASCII
        "python `"$scriptPath`" %*" | Out-File -FilePath "bin\djvu2hocr.bat" -Encoding ASCII -Append

        Write-Host "djvu2hocr wrapper created"

    - name: Set up pdfbeads wrapper
      shell: powershell
      run: |
        # Find pdfbeads from Ruby gems
        $pdfbeadsPath = (Get-Command pdfbeads).Source
        Write-Host "pdfbeads found at: $pdfbeadsPath"

        # Create wrapper batch file
        "@echo off" | Out-File -FilePath "bin\pdfbeads.bat" -Encoding ASCII
        "ruby `"$pdfbeadsPath`" %*" | Out-File -FilePath "bin\pdfbeads.bat" -Encoding ASCII -Append

        Write-Host "pdfbeads wrapper created"

    - name: Update converter to use .bat extensions
      shell: powershell
      run: |
        # Update the converter script to use .bat extensions on Windows
        $converterPath = "djvu2pdf_converter.py"
        $content = Get-Content $converterPath -Raw

        # Add platform detection and adjust commands
        $newContent = $content -replace 'cmd = \["djvu2hocr"', 'cmd = ["djvu2hocr.bat" if sys.platform == "win32" else "djvu2hocr"'
        $newContent = $newContent -replace 'cmd = \["pdfbeads"', 'cmd = ["pdfbeads.bat" if sys.platform == "win32" else "pdfbeads"'

        Set-Content -Path $converterPath -Value $newContent

    - name: List bin directory contents
      shell: powershell
      run: |
        Write-Host "Contents of bin directory:"
        Get-ChildItem bin -Recurse

    - name: Build executable with PyInstaller
      run: |
        pyinstaller build_windows.spec

    - name: Verify executable was created
      shell: powershell
      run: |
        if (Test-Path "dist\djvu2pdf.exe") {
          Write-Host "✓ Executable created successfully!"
          $fileSize = (Get-Item "dist\djvu2pdf.exe").Length / 1MB
          Write-Host "File size: $([math]::Round($fileSize, 2)) MB"
        } else {
          Write-Host "✗ Executable not found!"
          exit 1
        }

    - name: Upload executable as artifact
      uses: actions/upload-artifact@v4
      with:
        name: djvu2pdf-windows
        path: dist/djvu2pdf.exe
        retention-days: 90

    - name: Create Release (on tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/djvu2pdf.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
