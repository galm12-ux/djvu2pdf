name: Build Windows Executable

on:
  push:
    branches: [ main, master, claude/** ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allows manual triggering

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Setup DjVuLibre tools
      shell: bash
      run: |
        # Check if binaries already exist in repo
        if [ -f "bin/djvused.exe" ] && [ -f "bin/ddjvu.exe" ]; then
          echo "✓ Using DjVuLibre binaries from repository"
          ls -lh bin/*.exe bin/*.dll 2>/dev/null || true
        else
          echo "Binaries not found in repo, downloading from SourceForge..."
          mkdir -p bin

          # Try downloading (may fail with SourceForge)
          curl -L -o djvulibre.zip \
            "https://sourceforge.net/projects/djvu/files/DjVuLibre_Win32/3.5.28/djvulibre-3.5.28-win.zip/download" || {
            echo "ERROR: Download failed. Please add binaries to bin/ directory in repo."
            echo "See bin/README.md for instructions."
            exit 1
          }

          # Verify download
          fileSize=$(stat -c%s djvulibre.zip 2>/dev/null || stat -f%z djvulibre.zip)
          echo "Downloaded file size: $fileSize bytes"

          if [ $fileSize -lt 1000000 ]; then
              echo "ERROR: Downloaded file too small (expected >1MB)"
              echo "Please add DjVuLibre binaries manually to bin/ directory"
              exit 1
          fi

          # Extract
          echo "Extracting DjVuLibre..."
          unzip -q djvulibre.zip -d djvulibre
          cp djvulibre/djvulibre-3.5.28/bin/djvused.exe bin/
          cp djvulibre/djvulibre-3.5.28/bin/ddjvu.exe bin/
          cp djvulibre/djvulibre-3.5.28/bin/*.dll bin/
        fi

        echo "DjVuLibre tools ready"

    - name: Download djvu2hocr script directly
      shell: powershell
      run: |
        # Download djvu2hocr script directly from GitHub
        Write-Host "Downloading djvu2hocr..."
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/hocr/djvu2hocr" -OutFile "bin\djvu2hocr"

        # Download required Python modules
        New-Item -ItemType Directory -Force -Path "bin\djvu"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/cli.py" -OutFile "bin\cli.py"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/hocr.py" -OutFile "bin\hocr.py"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/text_zones.py" -OutFile "bin\text_zones.py"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/ipc.py" -OutFile "bin\ipc.py"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/temporary.py" -OutFile "bin\temporary.py"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/unicode_support.py" -OutFile "bin\unicode_support.py"
        Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jwilk/ocrodjvu/master/lib/utils.py" -OutFile "bin\utils.py"

        # Install lxml which is required
        pip install lxml

        Write-Host "djvu2hocr downloaded"

    - name: Setup LibTIFF tools
      shell: bash
      run: |
        # Check if tiffsplit already exists
        if [ -f "bin/tiffsplit.exe" ]; then
          echo "✓ Using LibTIFF binaries from repository"
        else
          echo "tiffsplit.exe not found, downloading from SourceForge..."

          # Try downloading
          curl -L -o libtiff-bin.zip \
            "https://sourceforge.net/projects/gnuwin32/files/tiff/3.8.2-1/tiff-3.8.2-1-bin.zip/download" || {
            echo "ERROR: Download failed. Please add tiffsplit.exe to bin/ directory"
            exit 1
          }
          curl -L -o libtiff-dep.zip \
            "https://sourceforge.net/projects/gnuwin32/files/tiff/3.8.2-1/tiff-3.8.2-1-dep.zip/download" || true

          echo "Extracting LibTIFF..."
          unzip -q libtiff-bin.zip -d libtiff
          unzip -q libtiff-dep.zip -d libtiff 2>/dev/null || true

          cp libtiff/bin/tiffsplit.exe bin/
          cp libtiff/bin/*.dll bin/ 2>/dev/null || true
        fi

        echo "LibTIFF tools ready"

    - name: Install pdfbeads
      run: gem install pdfbeads

    - name: Set up djvu2hocr wrapper
      shell: powershell
      run: |
        # Create wrapper batch file for djvu2hocr script
        $scriptPath = (Resolve-Path "bin\djvu2hocr").Path
        Write-Host "djvu2hocr script at: $scriptPath"

        # Create wrapper batch file
        "@echo off" | Out-File -FilePath "bin\djvu2hocr.bat" -Encoding ASCII
        "python `"$scriptPath`" %*" | Out-File -FilePath "bin\djvu2hocr.bat" -Encoding ASCII -Append

        Write-Host "djvu2hocr wrapper created"

    - name: Set up pdfbeads wrapper
      shell: powershell
      run: |
        # Find pdfbeads from Ruby gems
        $pdfbeadsPath = (Get-Command pdfbeads).Source
        Write-Host "pdfbeads found at: $pdfbeadsPath"

        # Create wrapper batch file
        "@echo off" | Out-File -FilePath "bin\pdfbeads.bat" -Encoding ASCII
        "ruby `"$pdfbeadsPath`" %*" | Out-File -FilePath "bin\pdfbeads.bat" -Encoding ASCII -Append

        Write-Host "pdfbeads wrapper created"

    - name: Update converter to use .bat extensions
      shell: powershell
      run: |
        # Update the converter script to use .bat extensions on Windows
        $converterPath = "djvu2pdf_converter.py"
        $content = Get-Content $converterPath -Raw

        # Add platform detection and adjust commands
        $newContent = $content -replace 'cmd = \["djvu2hocr"', 'cmd = ["djvu2hocr.bat" if sys.platform == "win32" else "djvu2hocr"'
        $newContent = $newContent -replace 'cmd = \["pdfbeads"', 'cmd = ["pdfbeads.bat" if sys.platform == "win32" else "pdfbeads"'

        Set-Content -Path $converterPath -Value $newContent

    - name: List bin directory contents
      shell: powershell
      run: |
        Write-Host "Contents of bin directory:"
        Get-ChildItem bin -Recurse

    - name: Build executable with PyInstaller
      run: |
        pyinstaller build_windows.spec

    - name: Verify executable was created
      shell: powershell
      run: |
        if (Test-Path "dist\djvu2pdf.exe") {
          Write-Host "✓ Executable created successfully!"
          $fileSize = (Get-Item "dist\djvu2pdf.exe").Length / 1MB
          Write-Host "File size: $([math]::Round($fileSize, 2)) MB"
        } else {
          Write-Host "✗ Executable not found!"
          exit 1
        }

    - name: Upload executable as artifact
      uses: actions/upload-artifact@v4
      with:
        name: djvu2pdf-windows
        path: dist/djvu2pdf.exe
        retention-days: 90

    - name: Create Release (on tags)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/djvu2pdf.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
